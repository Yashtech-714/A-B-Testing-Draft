name: Node.js CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  # ======================================
  # 1Ô∏è‚É£ BUILD STAGE
  # ======================================
  build:
    name: üèóÔ∏è Build Stage
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: |
          echo "Installing project dependencies..."
          npm ci

      - name: Build the project
        run: |
          echo "Building project..."
          npm run build --if-present

  # ======================================
  # 2Ô∏è‚É£ TEST STAGE
  # ======================================
  test:
    name: üß™ Test Stage
    runs-on: ubuntu-latest
    needs: build

    services:
      mongo:
        image: mongo:6
        ports: ['27017:27017']
        options: >-
          --health-cmd "mongo --eval 'db.runCommand({ ping: 1 })'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    env:
      MONGO_URI: mongodb://localhost:27017/testdb
      NODE_ENV: test

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run Unit + Integration Tests
        run: |
          echo "Running Jest / Mocha test suites..."
          npm test

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: test-results/

  # ======================================
  # 3Ô∏è‚É£ COVERAGE STAGE
  # ======================================
  coverage:
    name: üìä Coverage Stage
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate coverage report
        run: npm run coverage || echo "No coverage script found."

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/

  # ======================================
  # 4Ô∏è‚É£ LINT STAGE
  # ======================================
  lint:
    name: üîç Lint Stage
    runs-on: ubuntu-latest
    needs: coverage

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: |
          echo "Running ESLint..."
          npx eslint . -f stylish || true

      - name: Save lint report
        run: |
          mkdir -p lint-report
          npx eslint . -f html -o lint-report/eslint-report.html || true

      - name: Upload lint report
        uses: actions/upload-artifact@v4
        with:
          name: lint-report
          path: lint-report/

  # ======================================
  # 5Ô∏è‚É£ SECURITY SCAN STAGE
  # ======================================
  security:
    name: üõ°Ô∏è Security Scan Stage
    runs-on: ubuntu-latest
    needs: lint

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run security scan
        run: |
          echo "Running npm audit..."
          npm audit --json > security-report.json || true

      - name: Upload security report
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: security-report.json

  # ======================================
  # 6Ô∏è‚É£ DEPLOYMENT ARTIFACT STAGE
  # ======================================
  deploy:
    name: üöÄ Deployment Artifact
    runs-on: ubuntu-latest
    needs: [build, test, coverage, lint, security]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Create deployment package
        run: |
          mkdir -p deployment/reports
          cp -r src/ deployment/
          cp README.md package.json deployment/
          cp -r artifacts/* deployment/reports/ || true
          cd deployment
          zip -r ../deployment-package-${{ github.run_id }}.zip .
          cd ..

      - name: Upload deployment artifact
        uses: actions/upload-artifact@v4
        with:
          name: deployment-package
          path: deployment-package-*.zip
          retention-days: 30
